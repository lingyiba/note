# livegui password
```
ctrl alt f1 # new a terminal
sudo su
passwd gentoo
ctrl alt f7 # return login
# enter password just configured
```

# Change into root user
```
sudo passwd
su root
```

# Test network
```
ip address
ping -c 3 gentoo.org
```

# Partition disks
```
fdisk /dev/sda
```
## References
```
Device        Start       End   Sectors   Size Type
/dev/sda1      2048    526335    524288   256M EFI System
/dev/sda2    526336  50857983  50331648    24G Linux swap
/dev/sda3  50857984 468862094 418004111 199.3G Linux root (x86-64)
```

# Format partitions (Make file system)
```
mkfs.fat -F 32 /dev/sda1
mkfs.ext4 /dev/sda3
mkswap /dev/sda2
swapon /dev/sda2
```

# Mount root and swap partition
```
swapon /dev/sda2
mkdir -p /mnt/gentoo
mount /dev/sda3 /mnt/gentoo
```

# Install stage tarball
## Download stage tarball
```
cd /mnt/gentoo
links https://gentoo.org/downloads/
```
### Notes
* Search "Stage 3" by pressing "/" (slash)
* If you don't want to download "Stage 3" online, you can copy it from your disk to /mnt/gentoo folder
## Unpack the stage tarball
```
tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner
```

# Configure compile options
```
vim /mnt/gentoo/etc/portage/make.conf
```
```
cat /mnt/gentoo/usr/share/portage/config/make.conf.example
```
## References
```
COMMON_FLAGS="-march=native -O2 -pipe"
MAKEOPTS="-j6"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"
```

# Chroot
## View mirrors
```
links https://gentoo.org/downloads/mirrors/
```
### Notes
* `links https://gentoo.org/downloads/mirrors/` # By search (press "/") "China" to view mirrors in your country
## Add mirrors
```
vim /mnt/gentoo/etc/portage/make.conf
```
### References
```
# GCC
COMMON_FLAGS="-march=native -O2 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"
MAKEOPTS="-j6"
# GENTOO_MIRRORS="https://mirrors.ustc.edu.cn/gentoo/ https://mirrors.tuna.tsinghua.edu.cn/gentoo/ https://mirrors.163.com/gentoo/ https://mirrors.aliyun.com/gentoo/"
GENTOO_MIRRORS="https://mirrors.ustc.edu.cn/gentoo/ https://mirrors.tuna.tsinghua.edu.cn/gentoo/"
VIDEO_CARDS="intel i965"

# NOTE: This stage was built with the bindist Use flag enabled
EMERGE_DEFAULT_OPTS="--ask --verbose=y --keep-going --with-bdeps=y --load-average"

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C
```
## Configure Gentoo ebuild repository
```
mkdir -p /mnt/gentoo/etc/portage/repos.conf
vim /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
```
### References
```
[DEFAULT]
main-repo = gentoo

[gentoo]
location = /usr/portage
sync-type = rsync
#sync-uri = rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage/
sync-uri = rsync://rsync.mirrors.ustc.edu.cn/gentoo-portage/
auto-sync = yes
```
## Configure Gentoo-zh ebuild repository(Optional)
```

vim /mnt/gentoo/etc/portage/repos.conf/lyman.conf
mkdir -p /var/lib/layman/gentoo-zh
```
### References
```
[gentoo-zh]
location = /var/lib/layman/gentoo-zh
sync-type = git
sync-uri = https://github.com/microcai/gentoo-zh.git
auto-sync = yes

```
## Copy DNS info
```
cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
vim /mnt/gentoo/etc/resolv.conf
```
### References
```
# Generated by dhcpcd from eno1.dhcp
# /etc/resolv.conf.head can replace this line
#domain Home
#nameserver 192.168.10.1
nameserver 114.114.114.114
nameserver 8.8.8.8
# /etc/resolv.conf.tail can replace this line
```
## Mount filesystems
```
mount --types proc /proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --bind /run /mnt/gentoo/run
```
### Notes
```
mount --types proc /proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --make-rslave /mnt/gentoo/dev
mount --bind /run /mnt/gentoo/run
mount --make-slave /mnt/gentoo/run
```
* `--make-rslave` # Add the above three sentences if you are systemd
## Enter new environment
```
chroot /mnt/gentoo /bin/bash
source /etc/profile
```
```
export PS1="(chroot) ${PS1}"
```
## Mount boot partition
```
mount /dev/sda1 /boot
```

# Configure portage
## Update Gentoo ebuild repository
```
emerge-webrsync
emerge --sync --quiet
```
## Choose profile
```
eselect profile list
eselect profile set 5
```
### Notes
* `5` # THe fifth profile is "[5]   default/linux/amd64/17.1/desktop (stable) *"
## Update @world set
```
emerge --ask --verbose --update --deep --newuse @world
etc-update
emerge --ask --verbose --update --deep --newuse @world
```
### Notes
* `emerge --ask --verbose --update --deep --newuse @world` # 300 packages will spend several hours
* `etc-update` # enter "-3" to auto emerge all files

# Timezone
```
ls /usr/share/zoneinfo
```
## OpenRC
```
echo "Asia/Shanghai" > /etc/timezone
emerge --config sys-libs/timezone-data
```
### Notes
* `"Asia/Shanghai"` # Replace it with your timezone

# Configure locales
## Generate locale
```
echo "en_US.UTF-8 UTF-8
zh_CN.UTF-8 UTF-8" >> /etc/locale.gen
vim /etc/locale.gen
```
### References
```
en_US ISO-8859-1
en_US.UTF-8 UTF-8
#ja_JP.EUC-JP EUC-JP
#ja_JP.UTF-8 UTF-8
#ja_JP EUC-JP
#en_HK ISO-8859-1
#en_PH ISO-8859-1
#de_DE ISO-8859-1
```
## Generate specified locales
```
locale-gen
```
## List locale
```
eselect locale list
```
### References
```
(chroot) livecd / # eselect locale list
Available targets for the LANG variable:
  [1]   C
  [2]   C.utf8
  [3]   POSIX
  [4]   en_US
  [5]   en_US.iso88591
  [6]   en_US.utf8
  [7]   C.UTF8 *
  [ ]   (free form)
```
## Select locale
```
eselect locale set 6
. /etc/profile
```
### Notes
* `6` # The 6th locale is "en_US.utf-8"
* `. /etc/profile` # Update variable
## Reload environment
```
env-update && source /etc/profile && export PS1="(chroot) ${PS1}"
```

# Configure and compile kernel
## Install gentoo source
```
emerge --ask sys-kernel/gentoo-sources
eselect kernel list
eselect kernel set 1
ls -l /usr/src/linux
```
### Notes
* `1` # The first is "[1]   linux-6.0.9-gentoo"
## Manual configuration
```
lsmod
cd /usr/src/linux
make menuconfig
make -j6 && make modules_install
make install
```
### Notes
* `-j6` # Replace it with yours
## Build an inintramfs
```
emerge --ask sys-kernel/genkernel
genkernel --lvm --mdadm --install initramfs
ls /boot/initramfs*
```

# Configure filesystem info
```
vim /etc/fstab
```
## Notes
* `blkid` # Before enter "vim /etc/fstab" you can enter it
## References
```

UUID=CE8C-F6E1          /boot           vfat            defaults         0 0
UUID=4e1af3f0-fea3-41cd-b6aa-f7df16b1c260   swap swap   defaults,noatime 0 2
UUID=045ca314-503b-44b9-8be1-5b42ced6c398   /    ext4   defaults,noatime 0 1
```

# Configure network information
## OpenRC
## Configure host information
```
vim /etc/conf.d/hostname
```
### References
```
hostname="yaoniplan"
```
## netifrc (OpenRC)
```
emerge --ask --noreplace net-misc/netifrc
emerge -av networkmanager
emerge --ask net-misc/dhcpcd
emerge --ask net-wireless/iw net-wireless/wpa_supplicant
rc-update add NetworkManager default
```

# Configure system information
# Configure system logger (Optional)
```
emerge --ask app-admin/sysklogd
rc-update add sysklogd default
```

# Configure corn daemon (Optional)
```
emerge --ask sys-process/cronie
rc-update add cronie default
```

# Index file (Optional)
```
emerge --ask sys-apps/mlocate
```

# Configure filesystem tools
```
emerge --ask sys-fs/btrfs-progs
```
## References
```
Filesystem	Package
Ext 4	sys-fs/e2fsprogs
XFS	sys-fs/xfsprogs
ReiserFS	sys-fs/reiserfsprogs
JFS	sys-fs/jfsutils
VFAT (FAT32, ...)	sys-fs/dosfstools
Btrfs	sys-fs/btrfs-progs
ZFS	sys-fs/zfs
```

# Select boot loader
## GRUB(UEFI)
```
echo 'GRUB_PLATFORMS="efi-64"' >> /etc/portage/make.conf
emerge --ask --update --newuse --verbose sys-boot/grub
grub-install --target=x86_64-efi --efi-directory=/boot
grub-mkconfig -o /boot/grub/grub.cfg
```

# Reboot system
```
exit
```
```
cd
umount -l /mnt/gentoo/dev{/shm,/pts,}
umount -R /mnt/gentoo
reboot
```
## Notes
* Remove bootable CD, otherwise the CD might be booted again instead of the new Gentoo system

# User
```
useradd -m -G users,wheel,audio -s /bin/bash yaoniplan
passwd yaoniplan
```

# Portage Usage
```
emerge --sync
emerge-webrsync
```

# Update system
```
emerge --update --ask @world
```

# Configure Sudo
```
emerge --ask app-admin/sudo
vim /etc/env.d/99editor
env-update && source /etc/profile
visudo
echo "complete -cf sudo" >> /home/yaoniplan/.bashrc
```
## References
```
# Configuration file for eselect
# This file has been automatically generated.
EDITOR="/usr/bin/vim"
```
## References
```
## User privilege specification
##
root ALL=(ALL:ALL) ALL
yaoniplan ALL=(ALL:ALL) ALL

## Uncomment to allow members of group wheel to execute any command
# %wheel ALL=(ALL:ALL) ALL 
%wheel yaoniplan=(ALL:ALL) ALL

## Same thing without a password
# %wheel ALL=(ALL:ALL) NOPASSWD: ALL 
%wheel yaoniplan=(ALL:ALL) NOPASSWD: ALL
```
## Notes
* `echo "complete -cf sudo" >> /home/yaoniplan/.bashrc` # Configure bash completion, replace "yaoniplan" with your username

## Configure Wayland
```
sudo emerge --ask dev-libs/wayland
sudo vim /etc/portage/make.conf
sudo emerge --ask --verbose --update --deep --newuse @world
```
### References
```
USE="wayland"
```
## Configure SwayWM
```
sudo emerge --ask gui-wm/sway
mkdir -p ~/.config/sway/
cp /etc/sway/config ~/.config/sway/
sudo vim /home/yaoniplan/.bash_profile
sudo vim /usr/sbin/sway_luncher
XDG_RUNTIME_DIR=/run/usr/1000 sway
```
### References
```
#!/bin/bash
if test -z "${XDG_RUNTIME_DIR}"; then
    export XDG_RUNTIME_DIR=/tmp/${UID}-runtime-dir
    if ! test -d "${XDG_RUNTIME_DIR}"; then
        mkdir "${XDG_RUNTIME_DIR}"
        chmod 0700 "${XDG_RUNTIME_DIR}"
    fi
fi
```
### Notes
* `dbus-run-session sway` # Execute sway
## Configure Alacritty
```
sudo emerge --ask alacritty
mkdir -p ~/.config/alacritty
sudo vim ~/.config/alacritty/alacritty.yml
sudo env-update && source /etc/profile
```
### References
```
# Values for `shape`:
#    - ▇ Block
#    - _ Underline
#    - | Beam
cursor:
  style:
    shape: Beam
    blinking: Always
  blink_interval: 160

  vi_mode_style:
    shape: Beam
  thickness: 0.15
```
## Configure google-chrome
```
sudo emerge --ask www-client/google-chrome
sudo vim ~/.config/sway/config
```
### References
```
# www-client/google-chrom
assign [class="^Google-chrome$"] number 1
exec google-chrome-stable -enable-features=UseOzonePlatform -ozone-platform=wayland
```
* https://wiki.gentoo.org/wiki/Wayland

# WM
```
sudo emerge --ask xorg-server
sudo vim ~/.xinitrc
sudo emerge --ask x11-wm/i3-gaps
exec starx
```
## References
```
#!/bin/sh

exec i3
```
# Other packages
```
sudo emerge --ask redshift
sudo emerge --ask flameshot
sudo emerge --ask feh
sudo emerge --ask pulseaudio
sudo emerge --ask x11-misc/dmenu
```

# References
* https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation
* https://mirrors.ustc.edu.cn/help/gentoo-portage.html
* https://blog.yangmame.org/Gentoo%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B.html
* https://www.bilibili.com/video/BV1ny4y1i7G6?p=2
